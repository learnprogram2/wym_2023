## 演进中的架构

> 这一章讲了架构的演进:
>
> 半成品的分布式, 仿照unix的, 但是不符合当时的物理条件, 计算性能等没有办法实现
>
> 单体系统: 变成大单体, 大单体的概念应该是系统进程通讯啊什么的
>
> SOA时代: 第一个十年流行
>
> 微服务: 不同于SOA, 两种理念, 更偏向于理念
>
> 后微服务时代: 用mesh啊什么的
>
> 无服务时代: 感觉是serviceless, 函数化那种.









## 一. 访问远程服务

### 远程服务调用 RPC

remote procedure call, 面向方法/过程来编程

是为了让计算机调用远程方法, 像本地方法一样. 

**进程间通讯:** inter-process communication

- 管道, 信号, 信号量
- 消息队列, 共享内存, socket(当仅限于本机进程间通信时，套接字接口是被优化过的，不会经过网络协议栈)

- Socket 是网络栈的统一接口, 支持跨机器的进程间通信. 原始的分布式时代就是类似的统一接口, 把远程调用与本地的进程间通信统一编码

  程序员会误以为**通信是无成本的**

**RPC** 应该是一种高层次的或者说语言层次的特征，而不是像 IPC 那样，是低层次的或者说系统层次的特征成为工业界、学术界的主流观点。

需要处理`8 Fallacies of Distributed Computing` 8个问题

**RPC的三个基本问题:**

- 序列化和反序列化: 如何表示数据

- 如何传输协议: 应用层协议, 一般都是在TCP、UDP 的传输层协议上加的

  应用层协议需要考虑 许多参数之外的信息，譬如异常、超时、安全、认证、授权、事务，等等，都可能产生双方需要交换信息的需求

- 如何确定方法: Interface Description Language，IDL

**分裂的RPC协议:** 没有完美的rpc协议

- 面向对象的
- 性能的
- 简化的
- ...

### REST 设计风格

REST 无论是在思想上、概念上，还是使用范围上，与 RPC 都不尽相同. 

抽象的目标不一样, REST是面向资源的编程思想.

**REST 风格的系统原则:**

- client和server分离
- stateless无状态的
- Cacheability可缓存的,把应答缓存,减少交互附带的东西
- Layered System分层系统:
  - CDN
- Uniform Interface统一接口
  - Put, get, post...
- Code-On-Demand: 按需编码

REST 绑定于 HTTP 协议。



## 二. 事务处理

事务是为了保证系统之间相互关联的数据之间不会产生矛盾，即数据状态的**一致性**（Consistency）

根据**数据库经典理论**, 为了达到这个目标,需要3个方面共同来保障

- Atomic: 原子性
- Isolation: 隔离性
- Durability: 持久性

事务概念从DB开始扩展到所有数据一致性的场景

- 只有一个数据源时候, 使用AID来保证C是最经典的, **内部一致性**

- 多个数据源时候,变得复杂了, **外部一致性**

“”、“单个服务使用多个数据源”、“多个服务使用单个数据源”以及“多个服务使用多个数据源”

**本地事务Local Transaction:** 单个服务使用单个数据源

ACID

Commit Logging 保障数据持久性、原子性

锁来保证隔离性: 读写锁, 间隔锁(Range Lock)

**全局事务Global Transaction:** 单个服务多个数据源

X/Open组织制定了XA规范, 后来java中实现了一个JTA标准接口:

- TransactionManager
- XAResource

XA: 两阶段提交 2 Phase Commit 来保证一致性

- 准备阶段/投票阶段
- 提交阶段

需要的前提条件:

- 提交阶段的网络可靠, 不丢消息
- 必须保证准备阶段的数据要完整, 不能丢

对2Phase Commit的优化: 解决单点问题和准备阶段的性能问题

3Phase commit, 增加一个CanCommit 的询问阶段, 这个阶段很轻, 避免DoCommit很重的提交.

**共享事务Share Transaction:** 多个服务共用一个数据源

不过拆分微服务, 尽量少用共享数据

**分布式事务Distributed Transaction:** 多个服务同时访问多个数据源

在分布式服务环境下的事务处理机制

XA事务不可以在分布式环境中很好的应用,因为CAP理论 















